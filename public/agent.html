<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>kamdi24 - Mitarbeiter Dashboard</title>
  <script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0f0f1a;
      min-height: 100vh;
      color: #fff;
    }

    .dashboard {
      display: grid;
      grid-template-columns: 280px 1fr 320px;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      background: #1a1a2e;
      padding: 20px;
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
    }

    .logo {
      font-size: 1.8rem;
      font-weight: 700;
      background: linear-gradient(90deg, #e94560, #ff6b6b);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 5px;
    }

    .logo-subtitle {
      color: #666;
      font-size: 0.85rem;
      margin-bottom: 30px;
    }

    /* Agent Profile */
    .agent-profile {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .agent-profile-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 15px;
    }

    .agent-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #e94560, #ff6b6b);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      font-weight: 600;
    }

    .agent-name-input {
      flex: 1;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 10px;
      color: #fff;
      font-size: 1rem;
    }

    .agent-name-input:focus {
      outline: none;
      border-color: #e94560;
    }

    .status-selector {
      display: flex;
      gap: 8px;
    }

    .status-btn {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .status-btn.available {
      background: rgba(34, 197, 94, 0.2);
      color: #4ade80;
    }

    .status-btn.available:hover,
    .status-btn.available.active {
      background: rgba(34, 197, 94, 0.4);
    }

    .status-btn.offline {
      background: rgba(107, 114, 128, 0.2);
      color: #9ca3af;
    }

    .status-btn.offline:hover,
    .status-btn.offline.active {
      background: rgba(107, 114, 128, 0.4);
    }

    /* Queue Section */
    .queue-section {
      flex: 1;
      margin-top: 20px;
    }

    .section-title {
      font-size: 0.9rem;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .queue-count {
      background: #e94560;
      color: #fff;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.8rem;
    }

    .queue-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 400px;
      overflow-y: auto;
    }

    .queue-item {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid transparent;
    }

    .queue-item:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(233, 69, 96, 0.3);
    }

    .queue-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .queue-item-name {
      font-weight: 500;
    }

    .queue-item-type {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.8rem;
      color: #888;
    }

    .queue-item-type svg {
      width: 14px;
      height: 14px;
    }

    .queue-item-wait {
      font-size: 0.85rem;
      color: #e94560;
    }

    .queue-empty {
      text-align: center;
      padding: 30px;
      color: #666;
    }

    /* Main Content */
    .main-content {
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .main-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .main-title {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 20px;
      font-size: 0.9rem;
    }

    .connection-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4ade80;
    }

    .connection-dot.disconnected {
      background: #ef4444;
    }

    /* Call Area */
    .call-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 20px;
      overflow: hidden;
    }

    .no-call {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #666;
    }

    .no-call svg {
      width: 80px;
      height: 80px;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    .no-call p {
      font-size: 1.1rem;
    }

    /* Incoming Call */
    .incoming-call {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      text-align: center;
    }

    .incoming-call.visible {
      display: flex;
      flex: 1;
    }

    .incoming-pulse {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: rgba(233, 69, 96, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 30px;
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(233, 69, 96, 0.4); }
      50% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(233, 69, 96, 0); }
    }

    .incoming-pulse svg {
      width: 50px;
      height: 50px;
      color: #e94560;
    }

    .incoming-info h2 {
      font-size: 1.5rem;
      margin-bottom: 10px;
    }

    .incoming-info p {
      color: #888;
      margin-bottom: 5px;
    }

    .incoming-actions {
      display: flex;
      gap: 20px;
      margin-top: 30px;
    }

    .incoming-btn {
      padding: 15px 40px;
      border: none;
      border-radius: 30px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s ease;
    }

    .incoming-btn svg {
      width: 20px;
      height: 20px;
    }

    .incoming-btn.accept {
      background: linear-gradient(135deg, #00c853, #00e676);
      color: #fff;
    }

    .incoming-btn.accept:hover {
      transform: scale(1.05);
      box-shadow: 0 10px 30px rgba(0, 200, 83, 0.3);
    }

    .incoming-btn.decline {
      background: rgba(239, 68, 68, 0.2);
      color: #f87171;
    }

    .incoming-btn.decline:hover {
      background: rgba(239, 68, 68, 0.3);
    }

    /* Active Call */
    .active-call {
      display: none;
      flex-direction: column;
      flex: 1;
    }

    .active-call.visible {
      display: flex;
    }

    .video-grid {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      padding: 15px;
    }

    .video-grid.audio-only {
      grid-template-columns: 1fr;
    }

    .video-box {
      position: relative;
      background: #000;
      border-radius: 16px;
      overflow: hidden;
      min-height: 300px;
    }

    .video-box video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .video-box-label {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 0.85rem;
    }

    .audio-call-display {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px;
    }

    .audio-call-display.visible {
      display: flex;
    }

    .audio-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(135deg, #e94560, #ff6b6b);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      font-weight: 600;
      margin-bottom: 20px;
    }

    .audio-name {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 10px;
    }

    /* Customer no video display */
    .customer-no-video {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.8);
    }

    .customer-no-video.visible {
      display: flex;
    }

    .customer-no-video-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6, #60a5fa);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .customer-no-video-name {
      font-size: 1.2rem;
      font-weight: 500;
      margin-bottom: 5px;
    }

    .customer-no-video small {
      color: #888;
      font-size: 0.85rem;
    }

    /* Customer no audio info */
    .customer-no-audio-info {
      display: none;
      align-items: center;
      gap: 10px;
      padding: 12px 20px;
      background: rgba(245, 158, 11, 0.2);
      border-radius: 10px;
      margin: 10px 15px;
      color: #fbbf24;
      font-size: 0.9rem;
    }

    .customer-no-audio-info.visible {
      display: flex;
    }

    .customer-no-audio-info svg {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    .audio-wave-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
      height: 40px;
    }

    .audio-wave-indicator span {
      width: 4px;
      background: #e94560;
      border-radius: 2px;
      animation: wave 1s ease-in-out infinite;
    }

    .audio-wave-indicator span:nth-child(1) { height: 15px; animation-delay: 0s; }
    .audio-wave-indicator span:nth-child(2) { height: 25px; animation-delay: 0.1s; }
    .audio-wave-indicator span:nth-child(3) { height: 35px; animation-delay: 0.2s; }
    .audio-wave-indicator span:nth-child(4) { height: 25px; animation-delay: 0.3s; }
    .audio-wave-indicator span:nth-child(5) { height: 15px; animation-delay: 0.4s; }

    @keyframes wave {
      0%, 100% { transform: scaleY(1); }
      50% { transform: scaleY(1.5); }
    }

    /* Call Controls */
    .call-controls-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      padding: 20px;
      background: rgba(0, 0, 0, 0.3);
    }

    .call-timer {
      font-size: 1.2rem;
      font-weight: 600;
      color: #888;
      margin-right: 30px;
    }

    .ctrl-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .ctrl-btn svg {
      width: 22px;
      height: 22px;
    }

    .ctrl-btn.toggle {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }

    .ctrl-btn.toggle:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .ctrl-btn.toggle.active {
      background: #e94560;
    }

    .ctrl-btn.end {
      background: #e94560;
      color: #fff;
      width: 60px;
      height: 60px;
    }

    .ctrl-btn.end:hover {
      background: #ff6b6b;
      transform: scale(1.1);
    }

    .ctrl-btn.add-agent {
      background: rgba(59, 130, 246, 0.2);
      color: #60a5fa;
    }

    .ctrl-btn.add-agent:hover {
      background: rgba(59, 130, 246, 0.3);
    }

    /* Right Panel - Agents */
    .right-panel {
      background: #1a1a2e;
      padding: 20px;
      border-left: 1px solid rgba(255, 255, 255, 0.1);
    }

    .agents-section {
      margin-bottom: 30px;
    }

    .agent-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .agent-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .agent-item:hover {
      background: rgba(255, 255, 255, 0.08);
    }

    .agent-item-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6, #60a5fa);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .agent-item-info {
      flex: 1;
    }

    .agent-item-name {
      font-weight: 500;
      margin-bottom: 2px;
    }

    .agent-item-status {
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }

    .status-dot.available {
      background: #4ade80;
    }

    .status-dot.busy {
      background: #f59e0b;
    }

    .status-dot.offline {
      background: #6b7280;
    }

    .agent-item-action {
      padding: 6px 12px;
      background: rgba(59, 130, 246, 0.2);
      color: #60a5fa;
      border: none;
      border-radius: 6px;
      font-size: 0.8rem;
      cursor: pointer;
      display: none;
    }

    .agent-item-action.visible {
      display: block;
    }

    .agent-item-action:hover {
      background: rgba(59, 130, 246, 0.3);
    }

    /* Stats */
    .stats-section {
      margin-top: 30px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 10px;
    }

    .stat-label {
      font-size: 0.85rem;
      color: #888;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 600;
    }

    /* Registration Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-overlay.hidden {
      display: none;
    }

    .modal {
      background: #1a1a2e;
      border-radius: 20px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    .modal h2 {
      margin-bottom: 10px;
    }

    .modal p {
      color: #888;
      margin-bottom: 30px;
    }

    .modal input {
      width: 100%;
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      color: #fff;
      font-size: 1rem;
      margin-bottom: 20px;
    }

    .modal input:focus {
      outline: none;
      border-color: #e94560;
    }

    .modal button {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #e94560, #ff6b6b);
      border: none;
      border-radius: 12px;
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .modal button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(233, 69, 96, 0.3);
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .dashboard {
        grid-template-columns: 250px 1fr;
      }
      .right-panel {
        display: none;
      }
    }

    @media (max-width: 768px) {
      .dashboard {
        grid-template-columns: 1fr;
      }
      .sidebar {
        display: none;
      }
    }
  </style>
</head>
<body>
  <!-- Registration Modal -->
  <div class="modal-overlay" id="registrationModal">
    <div class="modal">
      <h2>Willkommen</h2>
      <p>Bitte geben Sie Ihren Namen ein, um sich anzumelden</p>
      <input type="text" id="agentNameInput" placeholder="Ihr Name" autofocus>
      <button onclick="registerAgent()">Anmelden</button>
    </div>
  </div>

  <div class="dashboard">
    <!-- Sidebar -->
    <aside class="sidebar">
      <h1 class="logo">kamdi24</h1>
      <p class="logo-subtitle">Mitarbeiter Dashboard</p>

      <div class="agent-profile">
        <div class="agent-profile-header">
          <div class="agent-avatar" id="myAvatar">M</div>
          <span id="myName" style="font-weight: 500;">Mitarbeiter</span>
        </div>
        <div class="status-selector">
          <button class="status-btn available active" onclick="setStatus('available')">Verfügbar</button>
          <button class="status-btn offline" onclick="setStatus('offline')">Offline</button>
        </div>
      </div>

      <div class="queue-section">
        <h3 class="section-title">
          Warteschlange
          <span class="queue-count" id="queueCount">0</span>
        </h3>
        <div class="queue-list" id="queueList">
          <div class="queue-empty">Keine wartenden Kunden</div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="main-header">
        <h2 class="main-title">Anrufbereich</h2>
        <div class="connection-status">
          <span class="connection-dot" id="connectionDot"></span>
          <span id="connectionText">Verbunden</span>
        </div>
      </div>

      <div class="call-area">
        <!-- No Call State -->
        <div class="no-call" id="noCallState">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
          </svg>
          <p>Warten auf eingehende Anrufe...</p>
        </div>

        <!-- Incoming Call -->
        <div class="incoming-call" id="incomingCallState">
          <div class="incoming-pulse">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
            </svg>
          </div>
          <div class="incoming-info">
            <h2 id="incomingCustomerName">Kunde</h2>
            <p id="incomingCallType">Videoanruf</p>
            <p id="incomingWaitTime">Wartet seit: 0 Sekunden</p>
          </div>
          <div class="incoming-actions">
            <button class="incoming-btn accept" onclick="acceptCall()">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
              </svg>
              Annehmen
            </button>
            <button class="incoming-btn decline" onclick="declineCall()">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
              Ablehnen
            </button>
          </div>
        </div>

        <!-- Active Call -->
        <div class="active-call" id="activeCallState">
          <div class="video-grid" id="videoGrid">
            <div class="video-box">
              <video id="localVideo" autoplay muted playsinline></video>
              <span class="video-box-label">Sie</span>
            </div>
            <div class="video-box">
              <video id="remoteVideo" autoplay playsinline></video>
              <div class="customer-no-video" id="customerNoVideoDisplay">
                <div class="customer-no-video-avatar" id="customerNoVideoAvatar">K</div>
                <div class="customer-no-video-name" id="customerNoVideoName">Kunde</div>
                <small>Kamera deaktiviert</small>
              </div>
              <span class="video-box-label" id="remoteVideoLabel">Kunde</span>
            </div>
          </div>
          <div class="customer-no-audio-info" id="customerNoAudioInfo">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />
            </svg>
            <span>Kunde hat kein Mikrofon - kann nur zuhören</span>
          </div>

          <div class="audio-call-display" id="audioCallDisplay">
            <div class="audio-avatar" id="audioCustomerAvatar">K</div>
            <div class="audio-name" id="audioCustomerName">Kunde</div>
            <div class="audio-wave-indicator">
              <span></span>
              <span></span>
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>

          <div class="call-controls-bar">
            <span class="call-timer" id="callTimer">00:00</span>
            <button class="ctrl-btn toggle" id="muteBtn" onclick="toggleMute()" title="Mikrofon stumm schalten">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
              </svg>
            </button>
            <button class="ctrl-btn toggle" id="videoBtn" onclick="toggleVideo()" title="Kamera ausschalten">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
              </svg>
            </button>
            <button class="ctrl-btn add-agent" onclick="showAddAgentModal()" title="Kollegen hinzufügen">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
              </svg>
            </button>
            <button class="ctrl-btn end" onclick="endCall()" title="Anruf beenden">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M5 3a2 2 0 00-2 2v1c0 8.284 6.716 15 15 15h1a2 2 0 002-2v-3.28a1 1 0 00-.684-.948l-4.493-1.498a1 1 0 00-1.21.502l-1.13 2.257a11.042 11.042 0 01-5.516-5.517l2.257-1.128a1 1 0 00.502-1.21L9.228 3.683A1 1 0 008.279 3H5z" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </main>

    <!-- Right Panel -->
    <aside class="right-panel">
      <div class="agents-section">
        <h3 class="section-title">Kollegen</h3>
        <div class="agent-list" id="agentList">
          <p style="color: #666; text-align: center; padding: 20px;">Keine Kollegen online</p>
        </div>
      </div>

      <div class="stats-section">
        <h3 class="section-title">Statistiken</h3>
        <div class="stat-card">
          <div class="stat-label">Anrufe heute</div>
          <div class="stat-value" id="callsToday">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Durchschn. Dauer</div>
          <div class="stat-value" id="avgDuration">0:00</div>
        </div>
      </div>
    </aside>
  </div>

  <script>
    // State
    let socket = null;
    let peer = null;
    let agentId = null;
    let agentName = '';
    let localStream = null;
    let currentCallId = null;
    let currentCallType = 'video';
    let incomingCustomerId = null;
    let currentCustomerHasVideo = true;
    let currentCustomerHasAudio = true;
    let currentCustomerName = '';
    let callStartTime = null;
    let timerInterval = null;
    let isMuted = false;
    let isVideoOff = false;
    let callsCount = 0;
    let totalCallDuration = 0;
    const remotePeers = new Map();

    // Initialize
    function init() {
      socket = io();

      socket.on('connect', () => {
        console.log('Socket connected');
        updateConnectionStatus(true);
        initPeer();
      });

      socket.on('disconnect', () => {
        console.log('Socket disconnected');
        updateConnectionStatus(false);
      });

      socket.on('agent:registered', (data) => {
        console.log('Agent registered:', data);
        agentId = data.agentId;
        localStorage.setItem('agentId', agentId);
        updateQueue(data.queue);
      });

      socket.on('queue:updated', (data) => {
        updateQueue(data);
      });

      socket.on('agents:updated', (data) => {
        updateAgentsList(data);
      });

      socket.on('call:incoming', (data) => {
        console.log('Incoming call:', data);
        showIncomingCall(data);
      });

      socket.on('call:start', async (data) => {
        console.log('Call start:', data);
        currentCallId = data.callId;
        currentCallType = data.callType;
        currentCustomerHasVideo = data.customerHasVideo !== false;
        currentCustomerHasAudio = data.customerHasAudio !== false;
        currentCustomerName = data.customerName;
        await startCallWithCustomer(data.customerPeerId, data.customerName, data.callType, data.customerHasVideo, data.customerHasAudio);
      });

      socket.on('call:join', async (data) => {
        console.log('Joining call:', data);
        currentCallId = data.callId;
        currentCallType = data.callType;
        await joinExistingCall(data);
      });

      socket.on('call:agent-joined', (data) => {
        console.log('Agent joined:', data);
        // New agent will call us
      });

      socket.on('call:ended', () => {
        console.log('Call ended');
        endCallCleanup();
        showNoCallState();
      });

      // Check for saved agent
      const savedAgentId = localStorage.getItem('agentId');
      const savedAgentName = localStorage.getItem('agentName');
      if (savedAgentName) {
        document.getElementById('agentNameInput').value = savedAgentName;
      }
    }

    function initPeer() {
      const host = window.location.hostname;
      const port = window.location.port || (window.location.protocol === 'https:' ? 443 : 80);
      const secure = window.location.protocol === 'https:';

      peer = new Peer({
        host: host,
        port: port,
        path: '/peerjs',
        secure: secure,
        debug: 2
      });

      peer.on('open', (id) => {
        console.log('Peer ID:', id);
      });

      peer.on('call', async (call) => {
        console.log('Incoming peer call from:', call.peer);
        
        try {
          if (!localStream) {
            localStream = await getMediaStream(currentCallType);
          }
          
          call.answer(localStream);
          
          call.on('stream', (remoteStream) => {
            console.log('Received remote stream from:', call.peer);
            addRemoteStream(call.peer, remoteStream);
          });

          call.on('close', () => {
            removeRemoteStream(call.peer);
          });

          remotePeers.set(call.peer, call);
        } catch (err) {
          console.error('Error answering peer call:', err);
        }
      });

      peer.on('error', (err) => {
        console.error('Peer error:', err);
      });
    }

    // Create an empty/silent stream when no media devices available
    function createEmptyStream(withVideo = false) {
      const ctx = new AudioContext();
      const oscillator = ctx.createOscillator();
      const dst = ctx.createMediaStreamDestination();
      oscillator.connect(dst);
      oscillator.start();
      const audioTrack = dst.stream.getAudioTracks()[0];
      audioTrack.enabled = false; // Mute it
      
      const tracks = [audioTrack];
      
      // Add a black video track if needed
      if (withVideo) {
        const canvas = document.createElement('canvas');
        canvas.width = 640;
        canvas.height = 480;
        const canvasCtx = canvas.getContext('2d');
        canvasCtx.fillStyle = '#000';
        canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
        const videoStream = canvas.captureStream(1);
        const videoTrack = videoStream.getVideoTracks()[0];
        tracks.push(videoTrack);
      }
      
      return new MediaStream(tracks);
    }

    async function getMediaStream(callType) {
      const constraints = {
        audio: true,
        video: callType === 'video'
      };

      try {
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        return stream;
      } catch (err) {
        console.error('Error getting media:', err);
        // If no media devices, create empty stream
        if (err.name === 'NotFoundError' || err.name === 'NotAllowedError') {
          console.log('No media devices found, using empty stream');
          return createEmptyStream(callType === 'video');
        }
        throw err;
      }
    }

    function registerAgent() {
      const name = document.getElementById('agentNameInput').value.trim();
      if (!name) {
        alert('Bitte geben Sie Ihren Namen ein');
        return;
      }

      agentName = name;
      localStorage.setItem('agentName', name);

      document.getElementById('myName').textContent = name;
      document.getElementById('myAvatar').textContent = name.charAt(0).toUpperCase();
      document.getElementById('registrationModal').classList.add('hidden');

      const savedAgentId = localStorage.getItem('agentId');
      socket.emit('agent:register', {
        agentId: savedAgentId,
        peerId: peer.id,
        name: name
      });
    }

    function setStatus(status) {
      document.querySelectorAll('.status-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`.status-btn.${status}`).classList.add('active');

      socket.emit('agent:status', { status });
    }

    function updateConnectionStatus(connected) {
      const dot = document.getElementById('connectionDot');
      const text = document.getElementById('connectionText');
      
      if (connected) {
        dot.classList.remove('disconnected');
        text.textContent = 'Verbunden';
      } else {
        dot.classList.add('disconnected');
        text.textContent = 'Getrennt';
      }
    }

    function updateQueue(data) {
      document.getElementById('queueCount').textContent = data.total;
      const list = document.getElementById('queueList');

      if (data.queue.length === 0) {
        list.innerHTML = '<div class="queue-empty">Keine wartenden Kunden</div>';
        return;
      }

      list.innerHTML = data.queue.map(customer => `
        <div class="queue-item" onclick="selectCustomer('${customer.id}')">
          <div class="queue-item-header">
            <span class="queue-item-name">${customer.name}</span>
            <span class="queue-item-type">
              ${customer.callType === 'video' ? 
                '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>' :
                '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>'
              }
              ${customer.callType === 'video' ? 'Video' : 'Audio'}
            </span>
          </div>
          <div class="queue-item-wait">Wartet: ${customer.waitTime}s</div>
        </div>
      `).join('');
    }

    function updateAgentsList(agents) {
      const list = document.getElementById('agentList');
      const otherAgents = agents.filter(a => a.id !== agentId);

      if (otherAgents.length === 0) {
        list.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Keine Kollegen online</p>';
        return;
      }

      list.innerHTML = otherAgents.map(agent => `
        <div class="agent-item">
          <div class="agent-item-avatar">${agent.name.charAt(0).toUpperCase()}</div>
          <div class="agent-item-info">
            <div class="agent-item-name">${agent.name}</div>
            <div class="agent-item-status">
              <span class="status-dot ${agent.status}"></span>
              ${agent.status === 'available' ? 'Verfügbar' : agent.status === 'busy' ? 'Im Gespräch' : 'Offline'}
            </div>
          </div>
          <button class="agent-item-action ${currentCallId && agent.status === 'available' ? 'visible' : ''}" 
                  onclick="addAgentToCall('${agent.id}')">
            Hinzufügen
          </button>
        </div>
      `).join('');
    }

    function selectCustomer(customerId) {
      // Manual selection - show incoming call UI
      incomingCustomerId = customerId;
    }

    function showIncomingCall(data) {
      incomingCustomerId = data.customerId;
      currentCallType = data.callType;

      document.getElementById('incomingCustomerName').textContent = data.customerName;
      document.getElementById('incomingCallType').textContent = 
        data.callType === 'video' ? 'Videoanruf' : 'Sprachanruf';
      document.getElementById('incomingWaitTime').textContent = 
        `Wartet seit: ${data.waitTime} Sekunden`;

      document.getElementById('noCallState').style.display = 'none';
      document.getElementById('incomingCallState').classList.add('visible');
      document.getElementById('activeCallState').classList.remove('visible');
    }

    function acceptCall() {
      if (!incomingCustomerId) return;

      socket.emit('agent:accept', { customerId: incomingCustomerId });
    }

    function declineCall() {
      incomingCustomerId = null;
      showNoCallState();
      setStatus('offline');
    }

    async function startCallWithCustomer(customerPeerId, customerName, callType, customerHasVideo = true, customerHasAudio = true) {
      try {
        localStream = await getMediaStream(callType);
        
        // Check if we actually have real video/audio
        const hasRealVideo = localStream && localStream.getVideoTracks().some(t => t.readyState === 'live' && t.enabled);
        const hasRealAudio = localStream && localStream.getAudioTracks().some(t => t.readyState === 'live' && t.enabled);
        
        if (callType === 'video') {
          if (hasRealVideo) {
            document.getElementById('localVideo').srcObject = localStream;
          }
          document.getElementById('videoGrid').classList.remove('audio-only');
          document.getElementById('audioCallDisplay').classList.remove('visible');
          document.getElementById('videoBtn').style.display = hasRealVideo ? 'flex' : 'none';
        } else {
          document.getElementById('videoGrid').classList.add('audio-only');
          document.getElementById('audioCallDisplay').classList.add('visible');
          document.getElementById('audioCustomerName').textContent = customerName;
          document.getElementById('audioCustomerAvatar').textContent = customerName.charAt(0).toUpperCase();
          document.getElementById('videoBtn').style.display = 'none';
        }

        // Call the customer
        console.log('Calling customer peer:', customerPeerId);
        const call = peer.call(customerPeerId, localStream);
        
        if (!call) {
          console.error('Failed to create call - peer.call returned null');
          alert('Fehler: Konnte Anruf nicht starten');
          return;
        }
        
        call.on('stream', (remoteStream) => {
          console.log('Received customer stream');
          if (callType === 'video' && customerHasVideo) {
            document.getElementById('remoteVideo').srcObject = remoteStream;
            document.getElementById('remoteVideo').style.display = 'block';
            document.getElementById('customerNoVideoDisplay').classList.remove('visible');
          } else if (callType === 'video' && !customerHasVideo) {
            // Customer has no video - show avatar instead
            document.getElementById('remoteVideo').style.display = 'none';
            document.getElementById('customerNoVideoDisplay').classList.add('visible');
            document.getElementById('customerNoVideoAvatar').textContent = customerName.charAt(0).toUpperCase();
            document.getElementById('customerNoVideoName').textContent = customerName;
          }
        });

        call.on('close', () => {
          console.log('Call with customer closed');
        });

        call.on('error', (err) => {
          console.error('Call error:', err);
        });

        remotePeers.set(customerPeerId, call);

        document.getElementById('remoteVideoLabel').textContent = customerName;
        
        // Show info if customer has no audio
        if (!customerHasAudio) {
          document.getElementById('customerNoAudioInfo').classList.add('visible');
        } else {
          document.getElementById('customerNoAudioInfo').classList.remove('visible');
        }
        
        showActiveCallState();
        startTimer();
        callsCount++;
        document.getElementById('callsToday').textContent = callsCount;

      } catch (err) {
        console.error('Error starting call:', err);
        alert('Fehler beim Starten des Anrufs: ' + err.message);
      }
    }

    async function joinExistingCall(data) {
      try {
        localStream = await getMediaStream(data.callType);
        
        // Call the customer
        const customerCall = peer.call(data.customerPeerId, localStream);
        customerCall.on('stream', (remoteStream) => {
          if (data.callType === 'video') {
            document.getElementById('remoteVideo').srcObject = remoteStream;
          }
        });
        remotePeers.set(data.customerPeerId, customerCall);

        // Call existing agents
        data.existingAgents.forEach(agentPeerId => {
          const agentCall = peer.call(agentPeerId, localStream);
          agentCall.on('stream', (remoteStream) => {
            // Handle additional agent streams
          });
          remotePeers.set(agentPeerId, agentCall);
        });

        if (data.callType === 'video') {
          document.getElementById('localVideo').srcObject = localStream;
          document.getElementById('videoGrid').classList.remove('audio-only');
          document.getElementById('audioCallDisplay').classList.remove('visible');
        } else {
          document.getElementById('videoGrid').classList.add('audio-only');
          document.getElementById('audioCallDisplay').classList.add('visible');
        }

        showActiveCallState();
        startTimer();

      } catch (err) {
        console.error('Error joining call:', err);
      }
    }

    function addAgentToCall(targetAgentId) {
      if (!currentCallId) return;
      socket.emit('call:add-agent', { callId: currentCallId, targetAgentId });
    }

    function toggleMute() {
      if (localStream) {
        const audioTracks = localStream.getAudioTracks();
        audioTracks.forEach(track => {
          track.enabled = !track.enabled;
        });
        isMuted = !isMuted;
        document.getElementById('muteBtn').classList.toggle('active', isMuted);
      }
    }

    function toggleVideo() {
      if (localStream && currentCallType === 'video') {
        const videoTracks = localStream.getVideoTracks();
        videoTracks.forEach(track => {
          track.enabled = !track.enabled;
        });
        isVideoOff = !isVideoOff;
        document.getElementById('videoBtn').classList.toggle('active', isVideoOff);
      }
    }

    function endCall() {
      if (currentCallId) {
        socket.emit('call:end', { callId: currentCallId });
      }
      endCallCleanup();
      showNoCallState();
    }

    function endCallCleanup() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }

      // Calculate call duration for stats
      if (callStartTime) {
        const duration = Math.floor((new Date() - callStartTime) / 1000);
        totalCallDuration += duration;
        const avgSeconds = Math.floor(totalCallDuration / callsCount);
        const avgMin = Math.floor(avgSeconds / 60);
        const avgSec = avgSeconds % 60;
        document.getElementById('avgDuration').textContent = 
          `${avgMin}:${avgSec.toString().padStart(2, '0')}`;
      }

      remotePeers.forEach((call) => {
        call.close();
      });
      remotePeers.clear();

      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }

      document.getElementById('localVideo').srcObject = null;
      document.getElementById('remoteVideo').srcObject = null;

      currentCallId = null;
      incomingCustomerId = null;
      callStartTime = null;
      isMuted = false;
      isVideoOff = false;

      document.getElementById('muteBtn').classList.remove('active');
      document.getElementById('videoBtn').classList.remove('active');
    }

    function startTimer() {
      callStartTime = new Date();
      timerInterval = setInterval(() => {
        const elapsed = Math.floor((new Date() - callStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
        const seconds = (elapsed % 60).toString().padStart(2, '0');
        document.getElementById('callTimer').textContent = `${minutes}:${seconds}`;
      }, 1000);
    }

    // UI State Management
    function showNoCallState() {
      document.getElementById('noCallState').style.display = 'flex';
      document.getElementById('incomingCallState').classList.remove('visible');
      document.getElementById('activeCallState').classList.remove('visible');
    }

    function showActiveCallState() {
      document.getElementById('noCallState').style.display = 'none';
      document.getElementById('incomingCallState').classList.remove('visible');
      document.getElementById('activeCallState').classList.add('visible');
    }

    function showAddAgentModal() {
      // The agent list already shows available agents with add buttons
      alert('Wählen Sie einen verfügbaren Kollegen aus der Liste rechts aus.');
    }

    // Handle Enter key in registration
    document.getElementById('agentNameInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        registerAgent();
      }
    });

    // Start
    init();
  </script>
</body>
</html>
